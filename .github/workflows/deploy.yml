name: Deploy to VPS

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  VPS_DEPLOY_PATH: /opt/perfume-matcher
  BACKEND_DOMAIN: kioskapi.gandom-perfume.ir
  FRONTEND_DOMAIN: kiosk.gandom-perfume.ir

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Create deployment directory structure
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e
            if [ ! -d "${{ env.VPS_DEPLOY_PATH }}" ]; then
              sudo mkdir -p ${{ env.VPS_DEPLOY_PATH }}
            fi
            sudo chown -R ${{ secrets.VPS_USER }}:${{ secrets.VPS_USER }} ${{ env.VPS_DEPLOY_PATH }} 2>/dev/null || true
            mkdir -p ${{ env.VPS_DEPLOY_PATH }}/backend
            mkdir -p ${{ env.VPS_DEPLOY_PATH }}/frontend
            mkdir -p ${{ env.VPS_DEPLOY_PATH }}/backend/media/uploads
            mkdir -p ${{ env.VPS_DEPLOY_PATH }}/backend/db
            mkdir -p ${{ env.VPS_DEPLOY_PATH }}/frontend/.next
            chmod 755 ${{ env.VPS_DEPLOY_PATH }}/backend/db || true
            chown -R ${{ secrets.VPS_USER }}:${{ secrets.VPS_USER }} ${{ env.VPS_DEPLOY_PATH }}/backend/db || true

      - name: Clean backend before copy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd ${{ env.VPS_DEPLOY_PATH }}/backend
            # Remove only code files, keep db/ and media/uploads
            find . -maxdepth 1 -type f -delete 2>/dev/null || true
            find . -maxdepth 1 -type d ! -name '.' ! -name 'db' ! -name 'media' -exec rm -rf {} + 2>/dev/null || true
            # Clean up cache files
            find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
            find . -name "*.pyc" -delete 2>/dev/null || true

      - name: Copy backend files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "backend"
          target: ${{ env.VPS_DEPLOY_PATH }}
          strip_components: 1
          overwrite: true

      - name: Clean backend excludes after copy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd ${{ env.VPS_DEPLOY_PATH }}/backend
            find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
            find . -name "*.pyc" -delete 2>/dev/null || true
            rm -rf .venv db.sqlite3 2>/dev/null || true

      - name: Clean frontend before copy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd ${{ env.VPS_DEPLOY_PATH }}/frontend
            # Remove only code files, keep .next and node_modules if they exist
            find . -maxdepth 1 -type f -delete 2>/dev/null || true
            find . -maxdepth 1 -type d ! -name '.' ! -name '.next' ! -name 'node_modules' ! -name '.env.local' -exec rm -rf {} + 2>/dev/null || true

      - name: Copy frontend files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "frontend"
          target: ${{ env.VPS_DEPLOY_PATH }}
          strip_components: 1
          overwrite: true

      - name: Clean frontend excludes after copy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd ${{ env.VPS_DEPLOY_PATH }}/frontend
            rm -rf node_modules .next 2>/dev/null || true

      - name: Copy deployment files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "docker-compose.yml"
          target: ${{ env.VPS_DEPLOY_PATH }}

      - name: Copy nginx files
        if: hashFiles('nginx/**') != ''
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "nginx"
          target: ${{ env.VPS_DEPLOY_PATH }}

      - name: Copy scripts files
        if: hashFiles('scripts/**') != ''
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "scripts"
          target: ${{ env.VPS_DEPLOY_PATH }}

      - name: Create backend .env file if not exists
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            if [ ! -f ${{ env.VPS_DEPLOY_PATH }}/backend/.env ]; then
              echo 'SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}' > ${{ env.VPS_DEPLOY_PATH }}/backend/.env
              echo 'DEBUG=False' >> ${{ env.VPS_DEPLOY_PATH }}/backend/.env
              echo 'ALLOWED_HOSTS=${{ env.BACKEND_DOMAIN }},${{ secrets.VPS_HOST }},localhost,127.0.0.1' >> ${{ env.VPS_DEPLOY_PATH }}/backend/.env
              echo 'CORS_ALLOWED_ORIGINS=https://${{ env.FRONTEND_DOMAIN }},http://${{ env.FRONTEND_DOMAIN }},http://localhost:3000' >> ${{ env.VPS_DEPLOY_PATH }}/backend/.env
              echo 'OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}' >> ${{ env.VPS_DEPLOY_PATH }}/backend/.env
              echo 'AI_MODEL=gpt-5-nano' >> ${{ env.VPS_DEPLOY_PATH }}/backend/.env
              echo 'ADMIN_ACCESS_KEY=${{ secrets.ADMIN_ACCESS_KEY }}' >> ${{ env.VPS_DEPLOY_PATH }}/backend/.env
            fi

      - name: Ensure frontend env (backend URL + admin key)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            ENV_FILE=${{ env.VPS_DEPLOY_PATH }}/frontend/.env.local
            mkdir -p ${{ env.VPS_DEPLOY_PATH }}/frontend
            touch $ENV_FILE
            if grep -q '^NEXT_PUBLIC_BACKEND_BASE_URL=' $ENV_FILE; then
              sed -i 's|^NEXT_PUBLIC_BACKEND_BASE_URL=.*|NEXT_PUBLIC_BACKEND_BASE_URL=https://${{ env.BACKEND_DOMAIN }}|' $ENV_FILE
            else
              echo 'NEXT_PUBLIC_BACKEND_BASE_URL=https://${{ env.BACKEND_DOMAIN }}' >> $ENV_FILE
            fi
            if grep -q '^NEXT_PUBLIC_ADMIN_KEY=' $ENV_FILE; then
              sed -i 's|^NEXT_PUBLIC_ADMIN_KEY=.*|NEXT_PUBLIC_ADMIN_KEY=${{ secrets.ADMIN_ACCESS_KEY }}|' $ENV_FILE
            else
              echo 'NEXT_PUBLIC_ADMIN_KEY=${{ secrets.ADMIN_ACCESS_KEY }}' >> $ENV_FILE
            fi

      - name: Deploy with Docker Compose
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e
            cd ${{ env.VPS_DEPLOY_PATH }}
            export NEXT_PUBLIC_BACKEND_BASE_URL=https://${{ env.BACKEND_DOMAIN }}
            export NEXT_PUBLIC_ADMIN_KEY='${{ secrets.ADMIN_ACCESS_KEY }}'
            echo "Admin key length: ${#NEXT_PUBLIC_ADMIN_KEY}"
            echo "Admin key prefix: ${NEXT_PUBLIC_ADMIN_KEY:0:10}..."
            docker compose down || true
            docker ps -a --filter "name=perfume-" --format "{{.Names}}" | xargs -r docker rm -f || true
            docker rm -f perfume-backend perfume-frontend 2>/dev/null || true
            docker rmi perfume-matcher-frontend 2>/dev/null || true
            docker rmi perfume-matcher-backend 2>/dev/null || true
            docker compose pull || true
            docker compose build --no-cache --build-arg NEXT_PUBLIC_BACKEND_BASE_URL=$NEXT_PUBLIC_BACKEND_BASE_URL --build-arg NEXT_PUBLIC_ADMIN_KEY=$NEXT_PUBLIC_ADMIN_KEY frontend
            docker compose build backend
            docker compose up -d
            sleep 5
            docker compose ps
            docker compose exec -T backend python manage.py migrate --noinput || true
            docker compose exec -T backend python manage.py collectstatic --noinput || true
            sudo nginx -t && sudo systemctl reload nginx || true
            docker compose ps

      - name: Health check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            sleep 10
            echo "Checking backend health..."
            curl -f http://localhost:8000/api/perfumes/ || echo "Backend health check failed"
            echo "Checking frontend health..."
            curl -f http://localhost:3000 || echo "Frontend health check failed"

      - name: Deployment summary
        run: |
          echo "Deployment completed!"
          echo "Backend API: https://${{ env.BACKEND_DOMAIN }}"
          echo "Frontend: https://${{ env.FRONTEND_DOMAIN }}"
