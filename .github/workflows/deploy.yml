name: Deploy to VPS

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  VPS_DEPLOY_PATH: /opt/perfume-matcher
  BACKEND_DOMAIN: kioskapi.gandom-perfume.ir
  FRONTEND_DOMAIN: kiosk.gandom-perfume.ir

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Create deployment directory structure
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            set -e
            # Ensure parent directory exists and has correct ownership
            if [ ! -d "${{ env.VPS_DEPLOY_PATH }}" ]; then
              sudo mkdir -p ${{ env.VPS_DEPLOY_PATH }}
            fi
            sudo chown -R ${{ secrets.VPS_USER }}:${{ secrets.VPS_USER }} ${{ env.VPS_DEPLOY_PATH }} 2>/dev/null || true

            # Create subdirectories (now with correct ownership)
            mkdir -p ${{ env.VPS_DEPLOY_PATH }}/backend
            mkdir -p ${{ env.VPS_DEPLOY_PATH }}/frontend
            mkdir -p ${{ env.VPS_DEPLOY_PATH }}/backend/media/uploads
            mkdir -p ${{ env.VPS_DEPLOY_PATH }}/backend/db
            mkdir -p ${{ env.VPS_DEPLOY_PATH }}/frontend/.next

            # Ensure db directory has proper permissions and ownership
            chmod 755 ${{ env.VPS_DEPLOY_PATH }}/backend/db || true
            chown -R ${{ secrets.VPS_USER }}:${{ secrets.VPS_USER }} ${{ env.VPS_DEPLOY_PATH }}/backend/db || true
          EOF

      - name: Copy backend files
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key" \
            --exclude '__pycache__' \
            --exclude '*.pyc' \
            --exclude '.venv' \
            --exclude 'db.sqlite3' \
            --exclude 'db/' \
            --exclude 'media/uploads/*' \
            backend/ ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:${{ env.VPS_DEPLOY_PATH }}/backend/

      - name: Copy frontend files
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key" \
            --exclude 'node_modules' \
            --exclude '.next' \
            --exclude '.env.local' \
            frontend/ ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:${{ env.VPS_DEPLOY_PATH }}/frontend/


      - name: Create backend .env file if not exists
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} bash -c "
            if [ ! -f ${{ env.VPS_DEPLOY_PATH }}/backend/.env ]; then
              echo 'SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}' > ${{ env.VPS_DEPLOY_PATH }}/backend/.env
              echo 'DEBUG=False' >> ${{ env.VPS_DEPLOY_PATH }}/backend/.env
              echo 'ALLOWED_HOSTS=${{ env.BACKEND_DOMAIN }},${{ secrets.VPS_HOST }},localhost,127.0.0.1' >> ${{ env.VPS_DEPLOY_PATH }}/backend/.env
              echo 'CORS_ALLOWED_ORIGINS=https://${{ env.FRONTEND_DOMAIN }},http://${{ env.FRONTEND_DOMAIN }},http://localhost:3000' >> ${{ env.VPS_DEPLOY_PATH }}/backend/.env
              echo 'OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}' >> ${{ env.VPS_DEPLOY_PATH }}/backend/.env
              echo 'AI_MODEL=gpt-5-mini' >> ${{ env.VPS_DEPLOY_PATH }}/backend/.env
              echo 'ADMIN_ACCESS_KEY=${{ secrets.ADMIN_ACCESS_KEY }}' >> ${{ env.VPS_DEPLOY_PATH }}/backend/.env
            fi
          "

      - name: Ensure frontend env (backend URL + admin key)
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} bash -c "
            ENV_FILE=${{ env.VPS_DEPLOY_PATH }}/frontend/.env.local
            mkdir -p ${{ env.VPS_DEPLOY_PATH }}/frontend
            touch \$ENV_FILE

            # Ensure NEXT_PUBLIC_BACKEND_BASE_URL is set/updated
            if grep -q '^NEXT_PUBLIC_BACKEND_BASE_URL=' \$ENV_FILE; then
              sed -i 's|^NEXT_PUBLIC_BACKEND_BASE_URL=.*|NEXT_PUBLIC_BACKEND_BASE_URL=https://${{ env.BACKEND_DOMAIN }}|' \$ENV_FILE
            else
              echo 'NEXT_PUBLIC_BACKEND_BASE_URL=https://${{ env.BACKEND_DOMAIN }}' >> \$ENV_FILE
            fi

            # Ensure NEXT_PUBLIC_ADMIN_KEY matches backend ADMIN_ACCESS_KEY
            if grep -q '^NEXT_PUBLIC_ADMIN_KEY=' \$ENV_FILE; then
              sed -i 's|^NEXT_PUBLIC_ADMIN_KEY=.*|NEXT_PUBLIC_ADMIN_KEY=${{ secrets.ADMIN_ACCESS_KEY }}|' \$ENV_FILE
            else
              echo 'NEXT_PUBLIC_ADMIN_KEY=${{ secrets.ADMIN_ACCESS_KEY }}' >> \$ENV_FILE
            fi
          "

      - name: Deploy with Docker Compose
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} bash -c "
            set -e
            cd ${{ env.VPS_DEPLOY_PATH }}

            # Export environment variables for docker-compose
            export NEXT_PUBLIC_BACKEND_BASE_URL=https://${{ env.BACKEND_DOMAIN }}
            export NEXT_PUBLIC_ADMIN_KEY='${{ secrets.ADMIN_ACCESS_KEY }}'

            # Verify the admin key is set (first 10 chars only for security)
            echo \"Admin key length: \${#NEXT_PUBLIC_ADMIN_KEY}\"
            echo \"Admin key prefix: \${NEXT_PUBLIC_ADMIN_KEY:0:10}...\"

            # Stop and remove old containers with correct names
            docker compose down || true

            # Remove any orphaned containers (those with random names)
            docker ps -a --filter \"name=perfume-\" --format \"{{.Names}}\" | xargs -r docker rm -f || true

            # Clean up any containers that might conflict
            docker rm -f perfume-backend perfume-frontend 2>/dev/null || true

            # Remove old frontend image to force rebuild
            docker rmi perfume-matcher-frontend 2>/dev/null || true

            # Use docker compose v2 (plugin)
            # Pull latest images or build if needed
            docker compose pull || true

            # Build and start services with explicit build args (no cache for frontend to ensure fresh build)
            docker compose build --no-cache --build-arg NEXT_PUBLIC_BACKEND_BASE_URL=\$NEXT_PUBLIC_BACKEND_BASE_URL --build-arg NEXT_PUBLIC_ADMIN_KEY=\$NEXT_PUBLIC_ADMIN_KEY frontend
            docker compose up -d

            # Wait a bit for containers to start
            sleep 5

            # Check if containers are running
            docker compose ps

            # Run backend migrations
            docker compose exec -T backend python manage.py migrate --noinput || true

            # Collect static files
            docker compose exec -T backend python manage.py collectstatic --noinput || true

            # Reload Nginx if configuration exists
            sudo nginx -t && sudo systemctl reload nginx || true

            # Verify containers are still running
            docker compose ps
          "

      - name: Health check
        run: |
          sleep 10
          ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            echo "Checking backend health..."
            curl -f http://localhost:8000/api/perfumes/ || echo "Backend health check failed"

            echo "Checking frontend health..."
            curl -f http://localhost:3000 || echo "Frontend health check failed"
          EOF

      - name: Deployment summary
        run: |
          echo "âœ… Deployment completed!"
          echo "Backend API: https://${{ env.BACKEND_DOMAIN }}"
          echo "Frontend: https://${{ env.FRONTEND_DOMAIN }}"
          echo "Backend (internal): http://localhost:8000"
          echo "Frontend (internal): http://localhost:3000"

